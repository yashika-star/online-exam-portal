# name: Build and Push to ACR
# on:
#   push:
#     branches:
#       - dev
# jobs:
#   build:
#     name: 'Build and Push to ACR'
#     runs-on: ubuntu-latest

#     defaults:
#       run:
#         shell: bash

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Docker Login
#         uses: azure/docker-login@v1
#         with:
#           login-server: ${{ secrets.ACR_URL }}
#           username: ${{ secrets.ACR_USERNAME }}
#           password: ${{ secrets.ACR_PASSWORD }}

#       - name: Build and Push to ACR
#         uses: docker/build-push-action@v2
#         with:
#           push: true
#           tags: ${{ secrets.ACR_URL }}/backend:latest
#           file: backend/Dockerfile
name: Build and Push to ACR
on:
  push:
    branches:
      - dev

jobs:
  build:
    name: 'Build and Push to ACR'
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@14a755a4e2fd6dff25794233def4f2cf3f866955
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Docker Login
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_URL }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push to ACR
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ secrets.ACR_URL }}/backend:latest
          file: backend/Dockerfile

      - name: Set AKS Cluster Context
        uses: azure/aks-set-context@94ccc775c1997a3fcfbfbce3c459fec87e0ab188
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          cluster-name: testcluster
          resource-group: testrg

      - name: Deploy to Backend Deploy
        run: kubectl apply -f backend/deployment.yaml
        
      - name: Deploy to Backed Service
        run: kubectl apply -f backend/service.yaml
